<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        body {
            padding-bottom: 50px;
            min-height: 100vh;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="container mt-5">
<h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
<div class="border p-4 mb-5 rounded">
    <form id="addUserForm">
        <div class="mb-3">
            <label for="name" class="form-label">–ò–º—è</label>
            <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
            <label for="lastName" class="form-label">–§–∞–º–∏–ª–∏—è</label>
            <input type="text" class="form-control" id="lastName" required>
        </div>
        <div class="mb-3">
            <label for="age" class="form-label">–í–æ–∑—Ä–∞—Å—Ç</label>
            <input type="number" class="form-control" id="age" required>
        </div>
        <button id="addUserBtn" type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </form>
</div>

<h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
<table class="table table-striped">
    <thead>
    <tr>
        <th>ID</th>
        <th>–ò–º—è</th>
        <th>–§–∞–º–∏–ª–∏—è</th>
        <th>–í–æ–∑—Ä–∞—Å—Ç</th>
        <th>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</th>
        <th>–£–¥–∞–ª–∏—Ç—å</th>
    </tr>
    </thead>
    <tbody id="userTableBody">
        <tr th:each="user :${users}">
            <td th:text="${user.id}"></td>
            <td th:text="${user.name}"></td>
            <td th:text="${user.lastName}"></td>
            <td th:text="${user.age}"></td>
            <td><button class="btn btn-sm btn-warning">‚úèÔ∏è</button></td>
            <td><button class="btn btn-sm btn-danger">üóëÔ∏è</button></td>
        </tr>
    </tbody>
</table>
<div class="mb-3"></div>
<script>
    function validate(value, regex) {
        return regex.test(value);
    }
    const nameRegex = /^\p{L}+$/u;
    const numberRegex = /^\d{1,2}$/;
    const errorFieldsMessage = '–ü–æ–ª—è –Ω–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.\n' +
        '–ò–º—è –∏ –§–∞–º–∏–ª–∏—è –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä. \n –í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 1 –∏–ª–∏ 2 —Ü–∏—Ñ—Ä—ã'

    $('#addUserForm').on('submit', function(e) {
        e.preventDefault();

        const name = $('input[id=name]').val();
        const lastName = $('input[id=lastName]').val()
        const age = $('input[id=age]').val();

        const isValidate = validate(name, nameRegex)
                        && validate(lastName, nameRegex)
                        && validate(age, numberRegex);

        if (!isValidate) {
            alert(errorFieldsMessage)
            return;
        }

        $.ajax({
            url: '/users/add',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({
                "name": name,
                "lastName": lastName,
                "age": age
            }),
            success: function(htmlTr) {
                $("table tbody").append(htmlTr);
                $('#addUserForm')[0].reset();
                alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + name + " " + lastName + " –¥–æ–±–∞–≤–ª–µ–Ω")
            },
            error: function() {
                alert(errorFieldsMessage)
            }
        });
    });

    $(document.body).on('click', '.btn-danger', function(e) {
        e.preventDefault();

        const $row = $(this).closest('tr')
        const userId = $row.children('td').first().text()

        $.ajax({
            url: '/users/remove',
            type: 'POST',
            data: {
                'id': userId
            },
            success: function () {
                $row.fadeOut(300, function (){
                    $row.remove()
                });
            },
            error: function() {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.')
            }
        })
    })

    function replaceWithInput($td) {
        const oldValue = $td.text().trim();
        $td.html(`<input type="text" value="${oldValue}" class="edit-input">`);
        $td.find('.edit-input').focus().select();
    }

    $(document.body).on('click', '.btn-warning', function(e) {
        e.preventDefault();

        const $row = $(this).closest('tr')
        const $fieldName = $row.children('td').eq(1);
        const $fieldLastName = $row.children('td').eq(2);
        const $fieldAge = $row.children('td').eq(3);

        replaceWithInput($fieldName);
        replaceWithInput($fieldLastName);
        replaceWithInput($fieldAge);

        $(this).removeClass('btn-warning')
            .addClass('btn-success')
            .text('OK');
    })

    $(document.body).on('click', '.btn-success', function (e) {
        e.preventDefault();

        const $btn = $(this)
        const $row = $(this).closest('tr')
        const userId = $row.children('td').first().text()

        const $fieldName = $row.children('td').eq(1).find('input');
        const $fieldLastName = $row.children('td').eq(2).find('input');
        const $fieldAge = $row.children('td').eq(3).find('input');

        const name = $fieldName.val()
        const lastName = $fieldLastName.val()
        const age = $fieldAge.val()

        const isValidate = validate(name, nameRegex)
            && validate(lastName, nameRegex)
            && validate(age, numberRegex);

        if (!isValidate) {
            alert(errorFieldsMessage)
            return;
        }

        $.ajax({
            url: '/users/update',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(
                {
                    'id': userId,
                    'name': name,
                    'lastName': lastName,
                    'age': age
                }
            ),
            success: function (data) {
                $row.children('td').eq(1).text(data.name);
                $row.children('td').eq(2).text(data.lastName);
                $row.children('td').eq(3).text(data.age)

                $btn.removeClass('btn-success')
                    .addClass('btn-warning')
                    .text('‚úèÔ∏è');
            },
            error: function() {
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω.')
            }
        })
    })

</script>
</body>
</html>
